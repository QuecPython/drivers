# BL0939 电能计量芯片示例代码说明文档

## 概述

本文档介绍如何使用 Quectel 提供的 BL0939 电能计量芯片驱动接口。BL0939 是一款高精度电能计量芯片，可测量交流电压、电流（双通道）和功率等参数。

------

## 快速开始

### 1. 初始化 BL0939 对象

```python
from bl0939 import Bl0939

# 参数说明: port=SPI端口号(默认1), mode=SPI模式(默认1), clk=时钟频率(默认0)
bl0939 = Bl0939(port=1, mode=1, clk=0)
```

### 2. 读取测量数据

```python
# 读取所有参数（A通道电流、B通道电流、电压）
ia, ib, vol = bl0939.read()

# 单独读取各参数
current_a = bl0939.current_a  # A通道电流有效值
current_b = bl0939.current_b  # B通道电流有效值
voltage = bl0939.voltage     # 电压有效值
```

## API 详细说明

### 类 `Bl0939`

#### 构造函数

```python
Bl0939(port=1, mode=1, clk=0)
```

- **参数**:
  - `port`: SPI 端口号 (默认1)
  - `mode`: SPI 模式 (默认1)
  - `clk`: SPI 时钟频率 (默认0)
- **功能**: 初始化 SPI 接口并复位芯片。

------

#### 方法

##### `read()`

```python
read() -> (int, int, int)
```

- **返回**: 三元组 `(A通道电流, B通道电流, 电压)`
- **功能**: 一次性读取所有测量值。

##### `reset()`

```python
reset()
```

- **功能**: 复位芯片（软复位）。

------

#### 属性

##### `current_a`

```python
current_a -> int
```

- **返回**: A通道电流有效值（原始寄存器值）
- **注意**: 需根据实际电路转换为实际电流值（如 mA/A）。

##### `current_b`

```python
current_b -> int
```

- **返回**: B通道电流有效值（原始寄存器值）

##### `voltage`

```python
voltage -> int
```

- **返回**: 电压有效值（原始寄存器值）
- **注意**: 需根据分压电路转换为实际电压值（如 V）。

------

## 示例代码

### 连续读取数据

```python
import utime
from bl0939 import Bl0939

bl0939 = Bl0939(port=1)

for i in range(10):
    ia, ib, vol = bl0939.read()
    print("A电流: {}, B电流: {}, 电压: {}".format(ia, ib, vol))
    utime.sleep(1)
```

### 输出说明

- 输出值为芯片寄存器的原始数据，需根据实际电路转换为物理量：
  - **电流转换公式**：
    `实际电流 = 寄存器值 × (分流电阻比例 / 校准系数)`
  - **电压转换公式**：
    `实际电压 = 寄存器值 × (分压电阻比例 / 校准系数)`

## 注意事项

1. **SPI 配置**：确保 SPI 端口、模式和时钟频率与硬件匹配。
2. **校准**：实际使用时需校准比例系数（如脉冲常数）。
3. **隔离设计**：测量高压时需添加光耦或互感器隔离。
4. **单位转换**：寄存器值为无符号整数，需根据数据手册转换为实际单位。

------

## 故障排查

- **SPI 通信失败**：检查接线（CS/CLK/MOSI/MISO）和端口配置。
- **数据异常**：确认分流电阻/分压电阻参数是否正确。

如需进一步帮助，请参考 BL0939 数据手册或联系 Quectel 技术支持